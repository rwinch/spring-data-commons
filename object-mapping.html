<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Object Mapping Fundamentals :: Spring Data Commons</title>
    <link rel="canonical" href="https://rwinch.github.io/spring-data-commons/object-mapping.html">
    <link rel="prev" href="upgrade.html">
    <link rel="next" href="repositories.html">
    <meta name="generator" content="Antora 3.2.0-alpha.2">
    <script>
!function (theme, navWidth) {
  if (theme === 'dark') document.documentElement.classList.add('dark-theme')
  if (navWidth) document.documentElement.style.setProperty('--nav-width', `${navWidth}px`)
}(localStorage && localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)') && 'dark'),
  localStorage && localStorage.getItem('nav-width'))
    </script>
    <link rel="stylesheet" href="./_/css/site.css">
    <link rel="stylesheet" href="./_/css/vendor/docsearch.css">
    <link rel="stylesheet" href="./_/css/vendor/asciidoctor-tabs.css">

    <meta name="version" content="3.2.0-SNAPSHOT">
    <meta name="component" content="data-commons">
    <link rel="icon" href="./_/img/favicon.ico" type="image/vnd.microsoft.icon">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://spring.io">
        <img
          id="springlogo"
          class="block"
          src="./_/img/spring-logo.svg"
          alt="Spring"
        />
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Why Spring</a>
          <div class="navbar-dropdown">
            <a
              class="navbar-item"
              href="https://spring.io/why-spring"
            >Overview</a>
            <a
              class="navbar-item"
              href="https://spring.io/microservices"
            >Microservices</a>
            <a
              class="navbar-item"
              href="https://spring.io/reactive"
            >Reactive</a>
            <a class="navbar-item" href="https://spring.io/event-driven">Event
              Driven</a>
            <a class="navbar-item" href="https://spring.io/cloud">Cloud</a>
            <a class="navbar-item" href="https://spring.io/web-applications">Web
              Applications</a>
            <a
              class="navbar-item"
              href="https://spring.io/serverless"
            >Serverless</a>
            <a class="navbar-item" href="https://spring.io/batch">Batch</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Learn</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://spring.io/learn">Overview</a>
            <a
              class="navbar-item"
              href="https://spring.io/quickstart"
            >Quickstart</a>
            <a class="navbar-item" href="https://spring.io/guides">Guides</a>
            <a class="navbar-item" href="https://spring.io/blog">Blog</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Projects</a>
          <div class="navbar-dropdown" style="min-width: 280px">
            <a
              class="navbar-item"
              href="https://spring.io/projects"
            >Overview</a>
            <a
              class="navbar-item"
              href="https://spring.io/projects/spring-boot"
            >Spring Boot</a>
            <a
              class="navbar-item"
              href="https://spring.io/projects/spring-framework"
            >Spring Framework</a>
            <a
              class="navbar-item"
              href="https://spring.io/projects/spring-cloud"
            >Spring Cloud</a>
            <a
              class="navbar-item"
              href="https://spring.io/projects/spring-cloud-dataflow"
            >Spring Cloud Data Flow</a>
            <a
              class="navbar-item"
              href="https://spring.io/projects/spring-data"
            >Spring Data</a>
            <a
              class="navbar-item"
              href="https://spring.io/projects/spring-integration"
            >Spring Integration</a>
            <a
              class="navbar-item"
              href="https://spring.io/projects/spring-batch"
            >Spring Batch</a>
            <a
              class="navbar-item"
              href="https://spring.io/projects/spring-security"
            >Spring Security</a>
            <a
              class="navbar-item navbar-item-special"
              href="https://spring.io/projects"
            >View all projects</a>
            <a class="navbar-item" href="https://spring.io/tools">Spring Tools 4</a>
            <a
              class="navbar-item navbar-item-special-2"
              href="https://start.spring.io"
            >Spring Initializr
              <svg
                class="external-link-icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 16 16"
              ><polyline
                  points="15 10.94 15 15 1 15 1 1 5.06 1"
                  fill="none"
                  stroke="currentColor"
                  stroke-miterlimit="10"
                  stroke-width="2"
                ></polyline><polyline
                  points="8.93 1 15 1 15 7.07"
                  fill="none"
                  stroke="currentColor"
                  stroke-miterlimit="10"
                  stroke-width="2"
                ></polyline><line
                  x1="15"
                  y1="1"
                  x2="8"
                  y2="8"
                  fill="none"
                  stroke="currentColor"
                  stroke-miterlimit="10"
                  stroke-width="2"
                ></line></svg></a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Academy</a>
          <div class="navbar-dropdown">
            <a
              class="navbar-item"
              href="https://spring.academy/courses"
            >Courses</a>
            <a
              class="navbar-item"
              href="https://spring.academy/learning-path"
            >Get Certified</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Support</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://spring.io/support">Overview</a>
            <a class="navbar-item" href="https://spring.io/security">Security
              Advisories</a>
          </div>
        </div>

        <div class="navbar-item has-dropdown is-hoverable is-community">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a
              class="navbar-item"
              href="https://spring.io/community"
            >Overview</a>
            <a class="navbar-item" href="https://spring.io/events">Events</a>
            <a class="navbar-item" href="https://spring.io/team">Team</a>
          </div>
        </div>
      </div>
    </div>
    <label class="theme-toggler">
      <input type="checkbox" type="checkbox" id="switch-theme-checkbox" />
      <span class="icon"><svg
          aria-hidden="true"
          focusable="false"
          data-prefix="fas"
          data-icon="moon"
          class="svg-inline--fa fa-moon moon"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 384 512"
        ><path
            fill="currentColor"
            d="M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6c-96.9 0-175.5-78.8-175.5-176c0-65.8 36-123.1 89.3-153.3c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"
          ></path>
        </svg>
        <svg
          aria-hidden="true"
          focusable="false"
          data-prefix="fas"
          data-icon="sun"
          class="svg-inline--fa fa-sun sun"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 512 512"
        ><path
            fill="currentColor"
            d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"
          ></path>
        </svg></span>
      <span class="text">light</span>
    </label>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="data-commons" data-version="3.2.0-SNAPSHOT">
  <aside class="nav">
    <div class="panels">
      <div class="nav-panel-menu is-active" data-panel="menu">
        <nav class="nav-menu">
<div class="context">
  <span class="title">Spring Data Commons</span>
  <span class="version">3.2.0-SNAPSHOT</span>
</div><div class="search">
  <button class="DocSearch-Button search-button">
    <svg enable-background="new 0 0 32 32" id="Glyph" version="1.1" viewBox="0 0 32 32" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <path d="M27.414,24.586l-5.077-5.077C23.386,17.928,24,16.035,24,14c0-5.514-4.486-10-10-10S4,8.486,4,14  s4.486,10,10,10c2.035,0,3.928-0.614,5.509-1.663l5.077,5.077c0.78,0.781,2.048,0.781,2.828,0  C28.195,26.633,28.195,25.367,27.414,24.586z M7,14c0-3.86,3.14-7,7-7s7,3.14,7,7s-3.14,7-7,7S7,17.86,7,14z" id="XMLID_223_"/>
    </svg>
    Search
    <span class="search-key"></span>
  </button>
</div>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="dependencies.html">Dependencies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="upgrade.html">Upgrading Spring Data</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="object-mapping.html">Object Mapping Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="repositories.html">Working with Spring Data Repositories</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repositories/core-concepts.html">Core concepts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repositories/query-methods.html">Query Methods</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repositories/definition.html">Defining Repository Interfaces</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repositories/query-methods-details.html">Defining Query Methods</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repositories/create-instances.html">Creating Repository Instances</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repositories/custom-implementations.html">Custom Implementations for Spring Data Repositories</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repositories/core-domain-events.html">Publishing Events from Aggregate Roots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repositories/core-extensions.html">Spring Data Extensions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="repositories-scrolling.html">Scrolling</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="repositories-null-handling.html">Null Handling of Repository Methods</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="repository-projections.html">Projections</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="query-by-example.html">Query by Example</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="auditing.html">Auditing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="custom-conversions.html">Custom Conversions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="entity-callbacks.html">Entity Callbacks</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="is-new-state-detection.html">Entity State Detection Strategies</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="kotlin.html">Kotlin Support</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kotlin/requirements.html">Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kotlin/null-safety.html">Null Safety</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kotlin/object-mapping.html">Object Mapping</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kotlin/extensions.html">Extensions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="kotlin/coroutines.html">Coroutines</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Appendices</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repository-namespace-reference.html">Namespace reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repository-populator-namespace-reference.html">Populators namespace reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repository-query-keywords-reference.html">Repository query keywords</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="repository-query-return-types-reference.html">Repository query return types</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
        </nav>
      </div>
    </div>
<ul id="nav-versions" class="nav-versions">
  <li class="component is-current">
    <a class="title" href="index.html">Spring Data Commons</a>
    <ul class="versions">
      <li class="version is-current is-latest">
        <a href="index.html">
          3.2.0-SNAPSHOT<span class="current">current</span>
        </a>
      </li>
    </ul>
  </li>
</ul>
    <div class="resize-handle--x"><span></span></div>
  </aside>
</div><main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<div class="search">
  <button class="DocSearch-Button search-button">
    <svg enable-background="new 0 0 32 32" id="Glyph" version="1.1" viewBox="0 0 32 32" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <path d="M27.414,24.586l-5.077-5.077C23.386,17.928,24,16.035,24,14c0-5.514-4.486-10-10-10S4,8.486,4,14  s4.486,10,10,10c2.035,0,3.928-0.614,5.509-1.663l5.077,5.077c0.78,0.781,2.048,0.781,2.828,0  C28.195,26.633,28.195,25.367,27.414,24.586z M7,14c0-3.86,3.14-7,7-7s7,3.14,7,7s-3.14,7-7,7S7,17.86,7,14z" id="XMLID_223_"/>
    </svg>
    Search
    <span class="search-key"></span>
  </button>
</div>
</div>
  <div class="content">
<aside class="sidebar">
  <div class="content">
    <div
      class="toc"
      data-title="Object Mapping Fundamentals"
      data-levels="2"
    >
      <div class="toc-menu"></div>
    </div>
      <div class="edit-this-page"><a href="https://github.com/rwinch/spring-data-commons/edit/antora/modules/ROOT/pages/object-mapping.adoc">Edit this Page</a></div>
      </div>
</aside><div class="doc">
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Spring Data Commons</a></li>
    <li><a href="object-mapping.html">Object Mapping Fundamentals</a></li>
  </ul>
</nav>
<article>
<h1 id="page-title" class="page">Object Mapping Fundamentals</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section covers the fundamentals of Spring Data object mapping, object creation, field and property access, mutability and immutability.
Note, that this section only applies to Spring Data modules that do not use the object mapping of the underlying data store (like JPA).
Also be sure to consult the store-specific sections for store-specific object mapping, like indexes, customizing column or field names or the like.</p>
</div>
<div class="paragraph">
<p>Core responsibility of the Spring Data object mapping is to create instances of domain objects and map the store-native data structures onto those.
This means we need two fundamental steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instance creation by using one of the constructors exposed.</p>
</li>
<li>
<p>Instance population to materialize all exposed properties.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping.object-creation"><a class="anchor" href="#mapping.object-creation"></a>Object creation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Data automatically tries to detect a persistent entity&#8217;s constructor to be used to materialize objects of that type.
The resolution algorithm works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If there is a single static factory method annotated with <code>@PersistenceCreator</code> then it is used.</p>
</li>
<li>
<p>If there is a single constructor, it is used.</p>
</li>
<li>
<p>If there are multiple constructors and exactly one is annotated with <code>@PersistenceCreator</code>, it is used.</p>
</li>
<li>
<p>If the type is a Java <code>Record</code> the canonical constructor is used.</p>
</li>
<li>
<p>If there&#8217;s a no-argument constructor, it is used.
Other constructors will be ignored.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The value resolution assumes constructor/factory method argument names to match the property names of the entity, i.e. the resolution will be performed as if the property was to be populated, including all customizations in mapping (different datastore column or field name etc.).
This also requires either parameter names information available in the class file or an <code>@ConstructorProperties</code> annotation being present on the constructor.</p>
</div>
<div class="paragraph">
<p>The value resolution can be customized by using Spring Framework&#8217;s <code>@Value</code> value annotation using a store-specific SpEL expression.
Please consult the section on store specific mappings for further details.</p>
</div>
<div id="mapping.object-creation.details" class="sidebarblock">
<div class="content">
<div class="title">Object creation internals</div>
<div class="paragraph">
<p>To avoid the overhead of reflection, Spring Data object creation uses a factory class generated at runtime by default, which will call the domain classes constructor directly.
I.e. for this example type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Person {
  Person(String firstname, String lastname) { … }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>we will create a factory class semantically equivalent to this one at runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class PersonObjectInstantiator implements ObjectInstantiator {

  Object newInstance(Object... args) {
    return new Person((String) args[0], (String) args[1]);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This gives us a roundabout 10% performance boost over reflection.
For the domain class to be eligible for such optimization, it needs to adhere to a set of constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it must not be a private class</p>
</li>
<li>
<p>it must not be a non-static inner class</p>
</li>
<li>
<p>it must not be a CGLib proxy class</p>
</li>
<li>
<p>the constructor to be used by Spring Data must not be private</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If any of these criteria match, Spring Data will fall back to entity instantiation via reflection.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping.property-population"><a class="anchor" href="#mapping.property-population"></a>Property population</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once an instance of the entity has been created, Spring Data populates all remaining persistent properties of that class.
Unless already populated by the entity&#8217;s constructor (i.e. consumed through its constructor argument list), the identifier property will be populated first to allow the resolution of cyclic object references.
After that, all non-transient properties that have not already been populated by the constructor are set on the entity instance.
For that we use the following algorithm:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the property is immutable but exposes a <code>with…</code> method (see below), we use the <code>with…</code> method to create a new entity instance with the new property value.</p>
</li>
<li>
<p>If property access (i.e. access through getters and setters) is defined, we&#8217;re invoking the setter method.</p>
</li>
<li>
<p>If the property is mutable we set the field directly.</p>
</li>
<li>
<p>If the property is immutable we&#8217;re using the constructor to be used by persistence operations (see <a href="#mapping.object-creation">Object creation</a>) to create a copy of the instance.</p>
</li>
<li>
<p>By default, we set the field value directly.</p>
</li>
</ol>
</div>
<div id="mapping.property-population.details" class="sidebarblock">
<div class="content">
<div class="title">Property population internals</div>
<div class="paragraph">
<p>Similarly to our <a href="#mapping.object-creation.details">optimizations in object construction</a> we also use Spring Data runtime generated accessor classes to interact with the entity instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Person {

  private final Long id;
  private String firstname;
  private @AccessType(Type.PROPERTY) String lastname;

  Person() {
    this.id = null;
  }

  Person(Long id, String firstname, String lastname) {
    // Field assignments
  }

  Person withId(Long id) {
    return new Person(id, this.firstname, this.lastame);
  }

  void setLastname(String lastname) {
    this.lastname = lastname;
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">A generated Property Accessor</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class PersonPropertyAccessor implements PersistentPropertyAccessor {

  private static final MethodHandle firstname;              <i class="conum" data-value="2"></i><b>(2)</b>

  private Person person;                                    <i class="conum" data-value="1"></i><b>(1)</b>

  public void setProperty(PersistentProperty property, Object value) {

    String name = property.getName();

    if ("firstname".equals(name)) {
      firstname.invoke(person, (String) value);             <i class="conum" data-value="2"></i><b>(2)</b>
    } else if ("id".equals(name)) {
      this.person = person.withId((Long) value);            <i class="conum" data-value="3"></i><b>(3)</b>
    } else if ("lastname".equals(name)) {
      this.person.setLastname((String) value);              <i class="conum" data-value="4"></i><b>(4)</b>
    }
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>PropertyAccessor&#8217;s hold a mutable instance of the underlying object. This is, to enable mutations of otherwise immutable properties.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By default, Spring Data uses field-access to read and write property values. As per visibility rules of <code>private</code> fields, <code>MethodHandles</code> are used to interact with fields.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The class exposes a <code>withId(…)</code> method that&#8217;s used to set the identifier, e.g. when an instance is inserted into the datastore and an identifier has been generated. Calling <code>withId(…)</code> creates a new <code>Person</code> object. All subsequent mutations will take place in the new instance leaving the previous untouched.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Using property-access allows direct method invocations without using <code>MethodHandles</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This gives us a roundabout 25% performance boost over reflection.
For the domain class to be eligible for such optimization, it needs to adhere to a set of constraints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Types must not reside in the default or under the <code>java</code> package.</p>
</li>
<li>
<p>Types and their constructors must be <code>public</code></p>
</li>
<li>
<p>Types that are inner classes must be <code>static</code>.</p>
</li>
<li>
<p>The used Java Runtime must allow for declaring classes in the originating <code>ClassLoader</code>. Java 9 and newer impose certain limitations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, Spring Data attempts to use generated property accessors and falls back to reflection-based ones if a limitation is detected.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at the following entity:</p>
</div>
<div class="listingblock">
<div class="title">A sample entity</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class Person {

  private final @Id Long id;                                                <i class="conum" data-value="1"></i><b>(1)</b>
  private final String firstname, lastname;                                 <i class="conum" data-value="2"></i><b>(2)</b>
  private final LocalDate birthday;
  private final int age;                                                    <i class="conum" data-value="3"></i><b>(3)</b>

  private String comment;                                                   <i class="conum" data-value="4"></i><b>(4)</b>
  private @AccessType(Type.PROPERTY) String remarks;                        <i class="conum" data-value="5"></i><b>(5)</b>

  static Person of(String firstname, String lastname, LocalDate birthday) { <i class="conum" data-value="6"></i><b>(6)</b>

    return new Person(null, firstname, lastname, birthday,
      Period.between(birthday, LocalDate.now()).getYears());
  }

  Person(Long id, String firstname, String lastname, LocalDate birthday, int age) { <i class="conum" data-value="6"></i><b>(6)</b>

    this.id = id;
    this.firstname = firstname;
    this.lastname = lastname;
    this.birthday = birthday;
    this.age = age;
  }

  Person withId(Long id) {                                                  <i class="conum" data-value="1"></i><b>(1)</b>
    return new Person(id, this.firstname, this.lastname, this.birthday, this.age);
  }

  void setRemarks(String remarks) {                                         <i class="conum" data-value="5"></i><b>(5)</b>
    this.remarks = remarks;
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The identifier property is final but set to <code>null</code> in the constructor.
The class exposes a <code>withId(…)</code> method that&#8217;s used to set the identifier, e.g. when an instance is inserted into the datastore and an identifier has been generated.
The original <code>Person</code> instance stays unchanged as a new one is created.
The same pattern is usually applied for other properties that are store managed but might have to be changed for persistence operations.
The wither method is optional as the persistence constructor (see 6) is effectively a copy constructor and setting the property will be translated into creating a fresh instance with the new identifier value applied.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>firstname</code> and <code>lastname</code> properties are ordinary immutable properties potentially exposed through getters.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>age</code> property is an immutable but derived one from the <code>birthday</code> property.
With the design shown, the database value will trump the defaulting as Spring Data uses the only declared constructor.
Even if the intent is that the calculation should be preferred, it&#8217;s important that this constructor also takes <code>age</code> as parameter (to potentially ignore it) as otherwise the property population step will attempt to set the age field and fail due to it being immutable and no <code>with…</code> method being present.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>comment</code> property is mutable and is populated by setting its field directly.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>remarks</code> property is mutable and is populated by invoking the setter method.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The class exposes a factory method and a constructor for object creation.
The core idea here is to use factory methods instead of additional constructors to avoid the need for constructor disambiguation through <code>@PersistenceCreator</code>.
Instead, defaulting of properties is handled within the factory method.
If you want Spring Data to use the factory method for object instantiation, annotate it with <code>@PersistenceCreator</code>.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping.general-recommendations"><a class="anchor" href="#mapping.general-recommendations"></a>General recommendations</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><em>Try to stick to immutable objects</em>&#8201;&#8212;&#8201;Immutable objects are straightforward to create as materializing an object is then a matter of calling its constructor only.
Also, this avoids your domain objects to be littered with setter methods that allow client code to manipulate the objects state.
If you need those, prefer to make them package protected so that they can only be invoked by a limited amount of co-located types.
Constructor-only materialization is up to 30% faster than properties population.</p>
</li>
<li>
<p><em>Provide an all-args constructor</em>&#8201;&#8212;&#8201;Even if you cannot or don&#8217;t want to model your entities as immutable values, there&#8217;s still value in providing a constructor that takes all properties of the entity as arguments, including the mutable ones, as this allows the object mapping to skip the property population for optimal performance.</p>
</li>
<li>
<p><em>Use factory methods instead of overloaded constructors to avoid <code>@PersistenceCreator</code></em>&#8201;&#8212;&#8201;With an all-argument constructor needed for optimal performance, we usually want to expose more application use case specific constructors that omit things like auto-generated identifiers etc.
It&#8217;s an established pattern to rather use static factory methods to expose these variants of the all-args constructor.</p>
</li>
<li>
<p><em>Make sure you adhere to the constraints that allow the generated instantiator and property accessor classes to be used</em>&#8201;&#8212;&#8201;</p>
</li>
<li>
<p><em>For identifiers to be generated, still use a final field in combination with an all-arguments persistence constructor (preferred) or a <code>with…</code> method</em>&#8201;&#8212;&#8201;</p>
</li>
<li>
<p><em>Use Lombok to avoid boilerplate code</em>&#8201;&#8212;&#8201;As persistence operations usually require a constructor taking all arguments, their declaration becomes a tedious repetition of boilerplate parameter to field assignments that can best be avoided by using Lombok&#8217;s <code>@AllArgsConstructor</code>.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="mapping.general-recommendations.override.properties"><a class="anchor" href="#mapping.general-recommendations.override.properties"></a>Overriding Properties</h3>
<div class="paragraph">
<p>Java&#8217;s allows a flexible design of domain classes where a subclass could define a property that is already declared with the same name in its superclass.
Consider the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SuperType {

   private CharSequence field;

   public SuperType(CharSequence field) {
      this.field = field;
   }

   public CharSequence getField() {
      return this.field;
   }

   public void setField(CharSequence field) {
      this.field = field;
   }
}

public class SubType extends SuperType {

   private String field;

   public SubType(String field) {
      super(field);
      this.field = field;
   }

   @Override
   public String getField() {
      return this.field;
   }

   public void setField(String field) {
      this.field = field;

      // optional
      super.setField(field);
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both classes define a <code>field</code> using assignable types. <code>SubType</code> however shadows <code>SuperType.field</code>.
Depending on the class design, using the constructor could be the only default approach to set <code>SuperType.field</code>.
Alternatively, calling <code>super.setField(…)</code> in the setter could set the <code>field</code> in <code>SuperType</code>.
All these mechanisms create conflicts to some degree because the properties share the same name yet might represent two distinct values.
Spring Data skips super-type properties if types are not assignable.
That is, the type of the overridden property must be assignable to its super-type property type to be registered as override, otherwise the super-type property is considered transient.
We generally recommend using distinct property names.</p>
</div>
<div class="paragraph">
<p>Spring Data modules generally support overridden properties holding different values.
From a programming model perspective there are a few things to consider:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Which property should be persisted (default to all declared properties)?
You can exclude properties by annotating these with <code>@Transient</code>.</p>
</li>
<li>
<p>How to represent properties in your data store?
Using the same field/column name for different values typically leads to corrupt data so you should annotate least one of the properties using an explicit field/column name.</p>
</li>
<li>
<p>Using <code>@AccessType(PROPERTY)</code> cannot be used as the super-property cannot be generally set without making any further assumptions of the setter implementation.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mapping.kotlin"><a class="anchor" href="#mapping.kotlin"></a>Kotlin support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Spring Data adapts specifics of Kotlin to allow object creation and mutation.</p>
</div>
<div class="sect2">
<h3 id="mapping.kotlin.creation"><a class="anchor" href="#mapping.kotlin.creation"></a>Kotlin object creation</h3>
<div class="paragraph">
<p>Kotlin classes are supported to be instantiated, all classes are immutable by default and require explicit property declarations to define mutable properties.</p>
</div>
<div class="paragraph">
<p>Spring Data automatically tries to detect a persistent entity&#8217;s constructor to be used to materialize objects of that type.
The resolution algorithm works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If there is a constructor that is annotated with <code>@PersistenceCreator</code>, it is used.</p>
</li>
<li>
<p>If the type is a <a href="#mapping.kotlin">Kotlin data cass</a> the primary constructor is used.</p>
</li>
<li>
<p>If there is a single static factory method annotated with <code>@PersistenceCreator</code> then it is used.</p>
</li>
<li>
<p>If there is a single constructor, it is used.</p>
</li>
<li>
<p>If there are multiple constructors and exactly one is annotated with <code>@PersistenceCreator</code>, it is used.</p>
</li>
<li>
<p>If the type is a Java <code>Record</code> the canonical constructor is used.</p>
</li>
<li>
<p>If there&#8217;s a no-argument constructor, it is used.
Other constructors will be ignored.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Consider the following <code>data</code> class <code>Person</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">data class Person(val id: String, val name: String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class above compiles to a typical class with an explicit constructor.We can customize this class by adding another constructor and annotate it with <code>@PersistenceCreator</code> to indicate a constructor preference:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">data class Person(var id: String, val name: String) {

    @PersistenceCreator
    constructor(id: String) : this(id, "unknown")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Kotlin supports parameter optionality by allowing default values to be used if a parameter is not provided.
When Spring Data detects a constructor with parameter defaulting, then it leaves these parameters absent if the data store does not provide a value (or simply returns <code>null</code>) so Kotlin can apply parameter defaulting.Consider the following class that applies parameter defaulting for <code>name</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">data class Person(var id: String, val name: String = "unknown")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Every time the <code>name</code> parameter is either not part of the result or its value is <code>null</code>, then the <code>name</code> defaults to <code>unknown</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="property-population-of-kotlin-data-classes"><a class="anchor" href="#property-population-of-kotlin-data-classes"></a>Property population of Kotlin data classes</h3>
<div class="paragraph">
<p>In Kotlin, all classes are immutable by default and require explicit property declarations to define mutable properties.
Consider the following <code>data</code> class <code>Person</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">data class Person(val id: String, val name: String)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This class is effectively immutable.
It allows creating new instances as Kotlin generates a <code>copy(…)</code> method that creates new object instances copying all property values from the existing object and applying property values provided as arguments to the method.</p>
</div>
</div>
<div class="sect2">
<h3 id="mapping.kotlin.override.properties"><a class="anchor" href="#mapping.kotlin.override.properties"></a>Kotlin Overriding Properties</h3>
<div class="paragraph">
<p>Kotlin allows declaring <a href="https://kotlinlang.org/docs/inheritance.html#overriding-properties">property overrides</a> to alter properties in subclasses.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">open class SuperType(open var field: Int)

class SubType(override var field: Int = 1) :
	SuperType(field) {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Such an arrangement renders two properties with the name <code>field</code>.
Kotlin generates property accessors (getters and setters) for each property in each class.
Effectively, the code looks like as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SuperType {

   private int field;

   public SuperType(int field) {
      this.field = field;
   }

   public int getField() {
      return this.field;
   }

   public void setField(int field) {
      this.field = field;
   }
}

public final class SubType extends SuperType {

   private int field;

   public SubType(int field) {
      super(field);
      this.field = field;
   }

   public int getField() {
      return this.field;
   }

   public void setField(int field) {
      this.field = field;
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Getters and setters on <code>SubType</code> set only <code>SubType.field</code> and not <code>SuperType.field</code>.
In such an arrangement, using the constructor is the only default approach to set <code>SuperType.field</code>.
Adding a method to <code>SubType</code> to set <code>SuperType.field</code> via <code>this.SuperType.field = …</code> is possible but falls outside of supported conventions.
Property overrides create conflicts to some degree because the properties share the same name yet might represent two distinct values.
We generally recommend using distinct property names.</p>
</div>
<div class="paragraph">
<p>Spring Data modules generally support overridden properties holding different values.
From a programming model perspective there are a few things to consider:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Which property should be persisted (default to all declared properties)?
You can exclude properties by annotating these with <code>@Transient</code>.</p>
</li>
<li>
<p>How to represent properties in your data store?
Using the same field/column name for different values typically leads to corrupt data so you should annotate least one of the properties using an explicit field/column name.</p>
</li>
<li>
<p>Using <code>@AccessType(PROPERTY)</code> cannot be used as the super-property cannot be set.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="mapping.kotlin.value.classes"><a class="anchor" href="#mapping.kotlin.value.classes"></a>Kotlin Value Classes</h3>
<div class="paragraph">
<p>Kotlin Value Classes are designed for a more expressive domain model to make underlying concepts explicit.
Spring Data can read and write types that define properties using Value Classes.</p>
</div>
<div class="paragraph">
<p>Consider the following domain model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-kotlin hljs" data-lang="kotlin">@JvmInline
value class EmailAddress(val theAddress: String)                                    <i class="conum" data-value="1"></i><b>(1)</b>

data class Contact(val id: String, val name:String, val emailAddress: EmailAddress) <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A simple value class with a non-nullable value type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Data class defining a property using the <code>EmailAddress</code> value class.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Non-nullable properties using non-primitive value types are flattened in the compiled class to the value type.
Nullable primitive value types or nullable value-in-value types are represented with their wrapper type and that affects how value types are represented in the database.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="upgrade.html">Upgrading Spring Data</a></span>
  <span class="next"><a href="repositories.html">Working with Spring Data Repositories</a></span>
</nav>
</article>
</div>  </div>
</main>
</div>
<footer class="footer flex">
    <div id="spring-links flex">
        <img id="springlogo" src="./_/img/spring-logo.svg" alt="Spring">
        <p class="smallest antialiased">© <script>var d = new Date();
        document.write(d.getFullYear());</script> <a href="https://www.vmware.com/">VMware</a>, Inc. or its affiliates. <a href="https://www.vmware.com/help/legal.html">Terms of Use</a> • <a href="https://www.vmware.com/help/privacy.html" rel="noopener noreferrer">Privacy</a> • <a href="https://spring.io/trademarks">Trademark Guidelines</a> <span id="thank-you-mobile">• <a href="https://spring.io/thank-you">Thank you</a></span> • <a href="https://www.vmware.com/help/privacy/california-privacy-rights.html">Your California Privacy Rights</a> • <a class="ot-sdk-show-settings">Cookie Settings</a> <span id="teconsent"></span></p>
        <p class="smallest antialiased has-gray-text">Apache®, Apache Tomcat®, Apache Kafka®, Apache Cassandra&trade;, and Apache Geode&trade; are trademarks or registered trademarks of the Apache Software Foundation in the United States and/or other countries. Java&trade;, Java&trade; SE, Java&trade; EE, and OpenJDK&trade; are trademarks of Oracle and/or its affiliates. Kubernetes® is a registered trademark of the Linux Foundation in the United States and other countries. Linux® is the registered trademark of Linus Torvalds in the United States and other countries. Windows® and Microsoft® Azure are registered trademarks of Microsoft Corporation. “AWS” and “Amazon Web Services” are trademarks or registered trademarks of Amazon.com Inc. or its affiliates. All other trademarks and copyrights are property of their respective owners and are only mentioned for informative purposes. Other names may be trademarks of their respective owners.</p>
    </div>
    <div id="social-icons" class="flex jc-between">
        <a href="https://www.youtube.com/user/SpringSourceDev" title="Youtube"><svg id="youtube-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40"><circle class="cls-1" cx="20" cy="20" r="20"/><path class="cls-2" d="M30.91,14.53a2.89,2.89,0,0,0-2-2C27.12,12,20,12,20,12s-7.12,0-8.9.47a2.9,2.9,0,0,0-2,2A30.56,30.56,0,0,0,8.63,20a30.44,30.44,0,0,0,.46,5.47,2.89,2.89,0,0,0,2,2C12.9,28,20,28,20,28s7.12,0,8.9-.47a2.87,2.87,0,0,0,2-2A30.56,30.56,0,0,0,31.37,20,28.88,28.88,0,0,0,30.91,14.53ZM17.73,23.41V16.59L23.65,20Z"/></svg></a>
        <a href="https://github.com/spring-projects" title="Github"><svg id="github-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 75.93 75.93"><path class="cls-1" d="M38,0a38,38,0,1,0,38,38A38,38,0,0,0,38,0Z"/></g><path class="cls-2" d="M38,15.59A22.95,22.95,0,0,0,30.71,60.3c1.15.21,1.57-.5,1.57-1.11s0-2,0-3.9c-6.38,1.39-7.73-3.07-7.73-3.07A6.09,6.09,0,0,0,22,48.86c-2.09-1.42.15-1.39.15-1.39a4.81,4.81,0,0,1,3.52,2.36c2,3.5,5.37,2.49,6.67,1.91a4.87,4.87,0,0,1,1.46-3.07c-5.09-.58-10.45-2.55-10.45-11.34a8.84,8.84,0,0,1,2.36-6.15,8.29,8.29,0,0,1,.23-6.07s1.92-.62,6.3,2.35a21.82,21.82,0,0,1,11.49,0c4.38-3,6.3-2.35,6.3-2.35a8.29,8.29,0,0,1,.23,6.07,8.84,8.84,0,0,1,2.36,6.15c0,8.81-5.37,10.75-10.48,11.32a5.46,5.46,0,0,1,1.56,4.25c0,3.07,0,5.54,0,6.29s.42,1.33,1.58,1.1A22.94,22.94,0,0,0,38,15.59Z"/></svg></a>
        <a href="https://twitter.com/springcentral" title="Twitter"><svg id="twitter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 75.93 75.93"><circle class="cls-1" cx="37.97" cy="37.97" r="37.97"/><path id="Twitter-2" data-name="Twitter" class="cls-2" d="M55.2,22.73a15.43,15.43,0,0,1-4.88,1.91,7.56,7.56,0,0,0-5.61-2.49A7.78,7.78,0,0,0,37,30a7.56,7.56,0,0,0,.2,1.79,21.63,21.63,0,0,1-15.84-8.23,8,8,0,0,0,2.37,10.52,7.66,7.66,0,0,1-3.48-1v.09A7.84,7.84,0,0,0,26.45,41a7.54,7.54,0,0,1-2,.28A7.64,7.64,0,0,1,23,41.09a7.71,7.71,0,0,0,7.18,5.47,15.21,15.21,0,0,1-9.55,3.37,15.78,15.78,0,0,1-1.83-.11,21.41,21.41,0,0,0,11.78,3.54c14.13,0,21.86-12,21.86-22.42,0-.34,0-.68,0-1a15.67,15.67,0,0,0,3.83-4.08,14.9,14.9,0,0,1-4.41,1.24A7.8,7.8,0,0,0,55.2,22.73Z"/></svg></a>
    </div>
</footer>
<script src="./_/js/site.js"></script>
<script async src="./_/js/vendor/highlight.js"></script>
<script async src="./_/js/vendor/asciidoctor-tabs.js" data-sync-storage-key="docs:preferred-tab"></script>
  </body>
</html>
